<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="创建一个简单的立方体，并添加基本的旋转动画。">
    <meta name="three-version" content="r150">
    <title>Three.js 示例 - 立方体</title>
    <link rel="stylesheet" href="../css/example-common.css">
</head>
<body>
    <div class="three-container" id="threeContainer"></div>
    
    <!-- 引入 Three.js -->
    <script src="../libs/three/0.150.0/three.min.js"></script>
    
    <!-- 
    ===================================================
    截图功能脚本 - 请勿修改此部分
    此脚本处理从父窗口发来的截图请求，用于生成示例封面
    ===================================================
    -->
    <script>
        // 全局变量，用于存储渲染器引用
        let _screenshotRenderer;
        
        // 添加消息监听器，处理截图请求
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'take-screenshot') {
                try {
                    // 获取当前渲染器
                    if (!_screenshotRenderer && window.renderer) {
                        _screenshotRenderer = window.renderer;
                    }
                    
                    // 确保渲染器已经初始化
                    if (!_screenshotRenderer) {
                        throw new Error('渲染器未初始化');
                    }
                    
                    // 强制渲染一帧，确保内容是最新的
                    if (window.scene && window.camera) {
                        _screenshotRenderer.render(window.scene, window.camera);
                    }
                    
                    // 获取canvas的图像数据（使用较低的质量和尺寸以减小文件大小）
                    const quality = event.data.quality || 0.8;
                    const canvas = _screenshotRenderer.domElement;
                    
                    // 创建一个较小尺寸的临时canvas
                    const tempCanvas = document.createElement('canvas');
                    const maxSize = 600; // 最大尺寸为600像素
                    
                    // 计算缩放比例，保持宽高比
                    const scale = Math.min(maxSize / canvas.width, maxSize / canvas.height);
                    tempCanvas.width = Math.floor(canvas.width * scale);
                    tempCanvas.height = Math.floor(canvas.height * scale);
                    
                    // 在临时canvas上绘制缩小的图像
                    const ctx = tempCanvas.getContext('2d');
                    ctx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // 获取缩小后的图像数据
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', quality);
                    
                    // 将图像数据发送回父窗口
                    window.parent.postMessage({
                        type: 'screenshot-data',
                        dataUrl: dataUrl
                    }, '*');
                } catch (error) {
                    console.error('截图失败:', error);
                    // 发送错误信息回父窗口
                    window.parent.postMessage({
                        type: 'screenshot-error',
                        error: error.message
                    }, '*');
                }
            }
        });
    </script>
    
    <!-- 示例代码 - 立方体示例 -->
    <script type="module">
        // Three.js 变量 - 这些变量将被暴露给全局作用域以便截图功能使用
        window.scene = null;
        window.camera = null;
        window.renderer = null;
        let mesh;
        
        // 初始化 Three.js
        function init() {
            // 创建场景
            window.scene = new THREE.Scene();
            window.scene.background = new THREE.Color(0x2c3e50);
            
            // 创建相机
            window.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            window.camera.position.z = 5;
            
            // 创建渲染器
            window.renderer = new THREE.WebGLRenderer({ antialias: true });
            window.renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('threeContainer').appendChild(window.renderer.domElement);
            
            // 创建立方体
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0x3498db,
                metalness: 0.3,
                roughness: 0.4
            });
            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
            
            // 添加光源
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            // 处理窗口大小变化
            window.addEventListener('resize', onWindowResize);
            
            // 开始动画
            animate();
        }
        
        // 窗口大小变化处理
        function onWindowResize() {
            window.camera.aspect = window.innerWidth / window.innerHeight;
            window.camera.updateProjectionMatrix();
            window.renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            // 旋转立方体
            mesh.rotation.x += 0.01;
            mesh.rotation.y += 0.01;
            
            window.renderer.render(window.scene, window.camera);
        }
        
        // 初始化
        init();
    </script>
</body>
</html>
